<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Street View Guessr — Starter</title>
  <style>
    :root { --bg:#0f1115; --card:#151822; --ink:#e8e8f2; --muted:#9aa3b2; --accent:#3b82f6; }
    * { box-sizing:border-box; }
    body { margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; background:var(--bg); color:var(--ink); }
    header { display:flex; align-items:center; justify-content:space-between; padding:12px 16px; gap:12px; border-bottom:1px solid #1e2230; position:sticky; top:0; background:linear-gradient(#0f1115, #0f1115cc); backdrop-filter:saturate(1.2) blur(6px); z-index:5; }
    h1 { font-size:16px; margin:0; letter-spacing:.5px; font-weight:700; }
    .pill { display:inline-flex; align-items:center; gap:8px; padding:8px 12px; background:var(--card); border:1px solid #242a3a; border-radius:999px; color:var(--muted); font-size:12px; }
    .pill b { color:var(--ink); }

    .wrap { display:grid; grid-template-columns: 1fr min(36vw, 520px); grid-template-rows:auto 1fr; height: calc(100vh - 56px); }
    #pano { width:100%; height:100%; }
    .sidebar { display:flex; flex-direction:column; gap:12px; padding:12px; background:linear-gradient(180deg, #0f1115 0%, #0f1115 40%, #0f1115 100%); border-left:1px solid #1e2230; }
    .card { background:var(--card); border:1px solid #242a3a; border-radius:16px; padding:12px; }
    .card h2 { font-size:14px; margin:0 0 8px; color:var(--muted); font-weight:600; letter-spacing:.4px; }
    #guessMap { width:100%; height:45vh; border-radius:12px; }

    .controls { display:flex; gap:8px; flex-wrap:wrap; }
    button {
      appearance:none; border:none; border-radius:12px; padding:10px 14px; font-weight:600; cursor:pointer; background:#1e2435; color:var(--ink); border:1px solid #2b334a; transition:.15s transform, .15s background;
    }
    button:hover { background:#26304a; }
    button:active { transform:translateY(1px); }
    button.primary { background:var(--accent); border-color:#2a64c6; color:white; }
    .row { display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .stat { font-size:13px; color:var(--muted); }
    .stat b { color:var(--ink); }
    .hint { font-size:12px; color:var(--muted); }
    .badge { font-size:11px; padding:4px 8px; border-radius:999px; background:#1b2030; border:1px solid #2b334a; color:#cfd6e6; }

    @media (max-width: 1000px) {
      .wrap { grid-template-columns: 1fr; grid-template-rows: 50vh 50vh; height:auto; }
      #guessMap { height:36vh; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Street View Guessr — Starter</h1>
    <div class="pill">Round <b id="round">1</b>/5 · Score <b id="score">0</b></div>
  </header>
  <div class="wrap">
    <div id="pano"></div>
    <aside class="sidebar">
      <div class="card">
        <h2>Guess on the map</h2>
        <div id="guessMap"></div>
        <div class="row" style="margin-top:10px;">
          <div class="stat">Your guess: <b id="guessText">—</b></div>
          <span class="badge" id="distanceBadge">— km</span>
        </div>
        <div class="controls" style="margin-top:10px;">
          <button id="btnNew" title="Start new game">New Game</button>
          <button id="btnHint">Hint</button>
          <button id="btnSubmit" class="primary">Submit Guess</button>
          <button id="btnNext" disabled>Next Round</button>
        </div>
        <div class="hint" style="margin-top:8px;">• Click anywhere on the map to place your guess. • Use Street View arrows to explore. • 5 rounds per game.</div>
      </div>
      <div class="card">
        <h2>Result</h2>
        <div class="stat">Last distance: <b id="lastDistance">—</b></div>
        <div class="stat">Last score: <b id="lastScore">—</b></div>
        <div class="stat">Total score: <b id="totalScore">0</b></div>
      </div>
    </aside>
  </div>

  <script>
    // ====== CONFIG ======
    const GAME_CONFIG = {
      rounds: 5,
      // Option A: choose random coords globally, then snap to nearest Street View pano
      randomGlobal: true,
      // Option B: seed with curated bounding boxes to improve odds of good panoramas
      boxes: [
        // [south, west, north, east]
        [24.396308, -125.0, 49.384358, -66.93457], // USA (approx)
        [50.0, -10.0, 59.0, 2.0], // UK
        [41.0,  -9.5, 44.0, 15.0], // Italy (central/north-ish)
        [-44.0, 112.0, -10.0, 154.0], // Australia
        [35.0, 128.0, 45.0, 146.0], // Japan north/east
        [-35.0, -73.0, -17.0, -53.0], // Chile center
        [-35.0, 18.0, -22.0, 33.0], // South Africa
      ],
      // Scoring: 0–5000, decays with distance (km)
      score(distanceKm) {
        // Exponential decay feels nice. 0 km → 5000; ~2,000 km → ~675; ~10,000 km → ~34
        const s = 5000 * Math.exp(-(distanceKm / 2000));
        return Math.max(0, Math.round(s));
      },
    };

    // ====== GOOGLE MAPS LOADER (v=weekly, geometry lib) ======
    function loadGoogle(cb){
      const apiKey = 'YOUR_GOOGLE_MAPS_API_KEY'; // TODO: replace
      if(apiKey.includes('YOUR_')){
        alert('Replace YOUR_GOOGLE_MAPS_API_KEY in the HTML to run the game.');
      }
      const s = document.createElement('script');
      s.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=geometry&v=weekly&callback=__gmReady`;
      s.async = true; s.defer = true; window.__gmReady = cb; document.head.appendChild(s);
    }

    // ====== GAME STATE ======
    let pano, panoSvc, guessMap, guessMarker, actualMarker, line;
    let currentRound = 1, totalScore = 0, hasSubmitted = false;
    let actualLatLng = null, currentPanoId = null; let hintCount = 0;

    // ====== UTIL ======
    function rndInBox([s, w, n, e]){
      return new google.maps.LatLng(
        s + Math.random() * (n - s),
        w + Math.random() * (e - w)
      );
    }
    function rndGlobal(){
      // Bias away from oceans by re-rolling until land-ish latitudes; still rough.
      // We'll rely on StreetViewService to snap.
      const lat = (Math.random() * 170) - 85; // -85..+85 to avoid poles
      const lng = (Math.random() * 360) - 180;
      return new google.maps.LatLng(lat, lng);
    }
    function km(meters){ return (meters/1000).toFixed(1); }
    function fmtLatLng(ll){ return `${ll.lat().toFixed(3)}, ${ll.lng().toFixed(3)}`; }

    function setText(id, text){ document.getElementById(id).textContent = text; }

    function setGuess(ll){
      if(!guessMarker){
        guessMarker = new google.maps.Marker({ map: guessMap, position: ll, draggable:false });
      } else { guessMarker.setPosition(ll); }
      setText('guessText', fmtLatLng(ll));
    }

    function clearOverlays(){
      if(line){ line.setMap(null); line = null; }
      if(actualMarker){ actualMarker.setMap(null); actualMarker = null; }
      if(guessMarker){ guessMarker.setMap(null); guessMarker = null; }
      setText('distanceBadge', '— km');
    }

    function newRound(){
      hasSubmitted = false; hintCount = 0; clearOverlays(); setText('lastDistance','—'); setText('lastScore','—');
      setText('round', currentRound); setText('score', totalScore);
      document.getElementById('btnSubmit').disabled = false;
      document.getElementById('btnNext').disabled = true;

      // Pick a random target, then request nearest Street View pano
      const seed = (GAME_CONFIG.randomGlobal ? rndGlobal() : rndInBox(GAME_CONFIG.boxes[Math.floor(Math.random()*GAME_CONFIG.boxes.length)]));
      panoSvc.getPanorama({ location: seed, radius: 50000, source: google.maps.StreetViewSource.OUTDOOR }, (data, status) => {
        if (status !== 'OK' || !data || !data.location){
          // retry quickly
          return newRound();
        }
        actualLatLng = data.location.latLng; currentPanoId = data.location.pano;
        pano.setPano(currentPanoId); pano.setPov({ heading: Math.random()*360, pitch: 0}); pano.setVisible(true);
      });
    }

    function submitGuess(){
      if(hasSubmitted || !guessMarker || !actualLatLng) return;
      hasSubmitted = true;
      const meters = google.maps.geometry.spherical.computeDistanceBetween(guessMarker.getPosition(), actualLatLng);
      const distanceKm = meters/1000;
      const roundScore = GAME_CONFIG.score(distanceKm);
      totalScore += roundScore;

      setText('distanceBadge', `${distanceKm.toFixed(1)} km`);
      setText('lastDistance', `${distanceKm.toFixed(1)} km`);
      setText('lastScore', `${roundScore}`);
      setText('totalScore', `${totalScore}`);
      setText('score', totalScore);

      actualMarker = new google.maps.Marker({ map: guessMap, position: actualLatLng, icon: { path: google.maps.SymbolPath.CIRCLE, scale: 6, fillColor:'#10b981', fillOpacity:1, strokeColor:'#094', strokeWeight:2 } });
      line = new google.maps.Polyline({ map: guessMap, path: [guessMarker.getPosition(), actualLatLng], strokeOpacity:0.9, strokeWeight:3 });
      guessMap.panTo(guessMarker.getPosition());

      document.getElementById('btnSubmit').disabled = true;
      document.getElementById('btnNext').disabled = false;
    }

    function nextRound(){
      if(currentRound < GAME_CONFIG.rounds){
        currentRound++; newRound();
      } else {
        alert(`Game over! Final score: ${totalScore}`);
        // reset
        currentRound = 1; totalScore = 0; newRound(); setText('totalScore','0');
      }
    }

    function giveHint(){
      if(!actualLatLng) return;
      hintCount++;
      // Simple hint tiers: continent-ish via lat/lng bands, then country via reverse geocode (optional).
      let msg = '';
      const lat = actualLatLng.lat(), lng = actualLatLng.lng();
      if(hintCount === 1){
        if(lat > 0 && Math.abs(lat) > 23.5) msg = 'Northern Hemisphere';
        else if(lat < 0 && Math.abs(lat) > 23.5) msg = 'Southern Hemisphere';
        else msg = 'Near the Equator';
      } else if(hintCount === 2){
        msg = (lng < -30 ? 'Western' : (lng > 30 ? 'Eastern' : 'Central')) + ' Hemisphere';
      } else {
        msg = 'Zoom your map around coasts and road density for clues.';
      }
      alert('Hint: ' + msg);
    }

    function init(){
      // Base map for guessing
      guessMap = new google.maps.Map(document.getElementById('guessMap'), {
        center: {lat: 20, lng: 0}, zoom: 2, streetViewControl:false, mapTypeControl:false, fullscreenControl:false, gestureHandling:'greedy', minZoom:2
      });
      guessMap.addListener('click', (e) => setGuess(e.latLng));

      // Street View
      pano = new google.maps.StreetViewPanorama(document.getElementById('pano'), {
        pov: { heading: 0, pitch: 0 }, addressControl:false, zoomControl:true, fullscreenControl:false, motionTrackingControl:false
      });
      panoSvc = new google.maps.StreetViewService();

      document.getElementById('btnNew').onclick = () => { currentRound = 1; totalScore = 0; setText('totalScore','0'); newRound(); };
      document.getElementById('btnSubmit').onclick = submitGuess;
      document.getElementById('btnNext').onclick = nextRound;
      document.getElementById('btnHint').onclick = giveHint;

      newRound();
    }

    // Kickoff
    loadGoogle(init);
  </script>
</body>
</html>
